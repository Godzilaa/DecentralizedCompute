// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Node {
  id        String   @id @default(cuid())
  nodeId    String   @unique @map("node_id")
  info      Json
  lastSeen  DateTime @map("last_seen")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  jobs Job[] @relation("AssignedNode")
  
  @@map("nodes")
}

model Job {
  id          String    @id @default(cuid())
  jobId       String    @unique @map("job_id")
  status      String    @default("pending")
  payload     Json
  createdAt   DateTime  @default(now()) @map("created_at")
  assignedNode String?  @map("assigned_node")
  startedAt   DateTime? @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  result      Json?
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  node        Node?     @relation("AssignedNode", fields: [assignedNode], references: [nodeId])
  provenance  Provenance[]
  logs        Log[]
  
  @@map("jobs")
}

model Provenance {
  id        String   @id @default(cuid())
  jobId     String   @map("job_id")
  record    Json
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  job Job @relation(fields: [jobId], references: [jobId])
  
  @@map("provenance")
}

model Log {
  id        Int      @id @default(autoincrement())
  jobId     String   @map("job_id")
  line      String
  timestamp DateTime @default(now()) @map("ts")
  
  // Relations
  job Job @relation(fields: [jobId], references: [jobId])
  
  @@map("logs")
}